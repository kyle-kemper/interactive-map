<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CaniX Interactive Map</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; height:100vh; }
        #sidebar { width: 300px; overflow-y:auto; padding:10px; background:#f4f4f4; }
        #map { flex:1; }
        .filter-item { margin-right: 10px; }
        .event-item { padding:5px; border-bottom:1px solid #ccc; cursor:pointer; }
        .event-item:hover { background:#ddd; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>Filters</h3>
    <div>
        <strong>Categories:</strong> <span id="filter-controls"></span>
    </div>
    <div style="margin-top:10px;">
        <strong>Filter by Date:</strong><br>
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button onclick="applyDateFilter()">Apply</button>
    </div>
    <h3 style="margin-top:20px;">Events</h3>
    <div id="event-list"></div>
</div>

<div id="map"></div>

<script>
    // Initialize map
    const map = L.map('map').setView([39.5, -98.35], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Custom icon
    function coloredIcon(color="blue") {
        return new L.Icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    const categoryLayers = {};
    const categoryIcons = {};
    const allMarkers = [];

    function parseDate(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr);
        return isNaN(d) ? null : d;
    }

    function updateEventList() {
        const eventList = document.getElementById("event-list");
        eventList.innerHTML = "";

        // Sort markers by date
        const sorted = allMarkers.slice().sort((a,b) => {
            if (!a.eventDate) return 1;
            if (!b.eventDate) return -1;
            return a.eventDate - b.eventDate;
        });

        sorted.forEach(marker => {
            // Only show visible markers
            const cat = marker.category;
            const checkbox = document.getElementById(`check-${cat}`);
            if (!checkbox.checked) return;

            const div = document.createElement("div");
            div.className = "event-item";
            div.innerHTML = `<strong>${marker.options.title || "Unnamed"}</strong><br>${marker.eventDate ? marker.eventDate.toDateString() : ""}`;
            div.onclick = () => {
                map.setView(marker.getLatLng(), 13);
                marker.openPopup();
            };
            eventList.appendChild(div);
        });
    }

    // Load CSV
    Papa.parse("pins.csv", {
        download: true,
        header: true,
        complete: function(results) {
            const filterContainer = document.getElementById("filter-controls");

            results.data.forEach(row => {
                if (!row.latitude || !row.longitude) return;

                const category = row.category || "Other";
                const iconColor = row.iconColor || "blue";
                const eventDate = parseDate(row.eventDate);

                if (!categoryLayer
