<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CaniX Interactive Map</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; }
        #map { height: 600px; width: 100%; }
        #filters { padding: 10px; margin-bottom: 8px; background: #f4f4f4; }
        .filter-item { margin-right: 15px; }
    </style>
</head>
<body>

<h2>CaniX Locations Map</h2>

<div id="filters"><strong>Categories:</strong> <span id="filter-controls"></span></div>
<div id="map"></div>

<script>
    // Initialize map
    const map = L.map('map').setView([39.5, -98.35], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Custom Map Icons
    function coloredIcon(color = "blue") {
        return new L.Icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    const categoryLayers = {}; // category â†’ cluster group
    const categoryIcons = {}; // store icons by category

    // Load CSV
    Papa.parse("pins.csv", {
        download: true,
        header: true,
        complete: function(results) {
            const filterContainer = document.getElementById("filter-controls");

            results.data.forEach(row => {
                if (!row.latitude || !row.longitude) return;

                const category = row.category || "Other";
                const iconColor = row.iconColor || "blue";

                // Create layer for category if new
                if (!categoryLayers[category]) {
                    categoryLayers[category] = L.markerClusterGroup().addTo(map);

                    // Create icon for category if needed
                    categoryIcons[category] = coloredIcon(iconColor);

                    // Add checkbox filter UI
                    const id = `check-${category}`;
                    filterContainer.innerHTML += `
                        <label class="filter-item">
                            <input type="checkbox" id="${id}" checked
                            onchange="toggleCategory('${category}')">
                            ${category}
                        </label>
                    `;
                }

                // Make marker
                const marker = L.marker(
                    [parseFloat(row.latitude), parseFloat(row.longitude)],
                    { icon: categoryIcons[category] }
                );

                const popup = `
                    <strong>${row.name || "Unnamed"}</strong><br>
                    ${row.description || ""}<br>
                    <em>${category}</em>
                `;

                marker.bindPopup(popup);
                categoryLayers[category].addLayer(marker);
            });
        }
    });

    // Toggle checkbox filter function
    function toggleCategory(category) {
        const checkbox = document.getElementById(`check-${category}`);
        if (checkbox.checked) {
            map.addLayer(categoryLayers[category]);
        } else {
            map.removeLayer(categoryLayers[category]);
        }
    }
</script>

</body>
</html>
